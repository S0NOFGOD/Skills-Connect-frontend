<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>SkillConnect Freelancer</title>

<link rel="stylesheet" href="style.css">

<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

<script>
(function(){
    emailjs.init("PpXJtmBS2cd6k1qfT");
})();
</script>

</head>
<body>

<div class="mobile-container">

<h2 style="margin-bottom:20px;">Freelancer</h2>

<!-- SIGNUP -->

<div id="signupCard" class="card">

<input id="su_name" class="input" placeholder="Full Name">
<input id="su_email" class="input" placeholder="Email">
<select id="su_skill" class="input">
<option value="">Select Skill</option>
<option>Barber</option>
<option>Hair Stylist</option>
<option>Makeup Artist</option>
<option>Tailor</option>
<option>Phone Repair Technician</option>
<option>Plumber</option>
<option>Electrician</option>
<option>Carpenter</option>
<option>Mechanic</option>
<option>Cleaner</option>
<option>Chef</option>
</select>

<input id="su_phone" class="input" placeholder="Phone Number">
<input id="su_location" class="input" placeholder="Location" readonly>

<button class="btn" onclick="fetchLocation()">Find My Location</button>

<input type="file" id="su_photo" class="input" accept="image/*">
<input id="su_password" type="password" class="input" placeholder="Password">
<input id="su_confirm" type="password" class="input" placeholder="Confirm Password">

<button class="btn" onclick="signup()">Sign Up</button>

<br><br>
<button class="btn" onclick="showLogin()">Login Instead</button>

</div>

<!-- LOGIN -->

<div id="loginCard" class="card" style="display:none;">
<input id="li_email" class="input" placeholder="Email">
<input id="li_password" type="password" class="input" placeholder="Password">
<button class="btn" onclick="login()">Login</button>

<br><br>
<button class="btn" onclick="showForgot()">Forgot Password</button>
</div>

<!-- FORGOT PASSWORD -->

<div id="forgotCard" class="card" style="display:none;">
<input id="fp_email" class="input" placeholder="Email">
<button class="btn" onclick="sendReset()">Send Reset Code</button>

<div id="resetFields" style="display:none;">
<input id="fp_code" class="input" placeholder="Enter Code">
<input id="fp_newpass" type="password" class="input" placeholder="New Password">
<input id="fp_confirmpass" type="password" class="input" placeholder="Confirm Password">
<button class="btn" onclick="updatePassword()">Update Password</button>
</div>
</div>

</div>

<script src="js/app.js"></script>

<script>

let resetCode = null;
let resetEmail = null;

// FETCH LOCATION
function fetchLocation(){
    let input = document.getElementById("su_location");
    input.value = "Loading... hold on while fetching coordinates";

    if(!navigator.geolocation){
        alert("Geolocation is not supported by your browser");
        input.value = "";
        return;
    }

    navigator.geolocation.getCurrentPosition(async function(position){
        let lat = position.coords.latitude;
        let lon = position.coords.longitude;

        try {
            // Use OpenStreetMap Nominatim API to reverse geocode
            let response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`);
            let data = await response.json();

            let city = data.address.city || data.address.town || data.address.village || "";
            let state = data.address.state || "";
            input.value = city + (state ? ", " + state : "");
        } catch(err){
            console.error(err);
            input.value = "Unable to fetch location";
        }

    }, function(error){
        console.error(error);
        input.value = "Location permission denied";
    });
}

// SIGNUP
function signup(){

    let name = document.getElementById("su_name").value.trim();
    let email = document.getElementById("su_email").value.trim();
    let skill = document.getElementById("su_skill").value;
    let phone = document.getElementById("su_phone").value.trim();
    let location = document.getElementById("su_location").value.trim();
    let password = document.getElementById("su_password").value;
    let confirm = document.getElementById("su_confirm").value;
    let photo = document.getElementById("su_photo").files[0];

    if(!name||!email||!skill||!phone||!location||!password||!confirm||!photo){
        alert("Please complete all fields");
        return;
    }

    if(password !== confirm){
        alert("Passwords do not match");
        return;
    }

    let reader = new FileReader();

    reader.onload = function(){

        let freelancers = getFreelancers() || [];

        if(freelancers.find(u=>u.email===email)){
            alert("Email already exists");
            return;
        }

        let user = {
            name:name,
            email:email,
            skill:skill,
            phone:phone,
            location:location,
            password:password,
            photo:reader.result,
            rating:"5.0",
            projects:"0"
        };

        freelancers.push(user);

        saveFreelancers(freelancers);

        setSession(user,"freelancer");

        location.href="freelancerdashboard.html";

    };

    reader.readAsDataURL(photo);

}

// LOGIN
function login(){

    let email = document.getElementById("li_email").value;
    let password = document.getElementById("li_password").value;

    let freelancers = getFreelancers() || [];

    let user = freelancers.find(u =>
        u.email===email && u.password===password
    );

    if(!user){
        alert("Invalid login");
        return;
    }

    setSession(user,"freelancer");

    location.href="freelancerdashboard.html";

}

// SHOW LOGIN
function showLogin(){

    document.getElementById("signupCard").style.display="none";
    document.getElementById("loginCard").style.display="block";

}

// SHOW FORGOT
function showForgot(){

    document.getElementById("loginCard").style.display="none";
    document.getElementById("forgotCard").style.display="block";

}

// SEND RESET CODE
function sendReset(){

    let email = document.getElementById("fp_email").value;

    let freelancers = getFreelancers() || [];

    let user = freelancers.find(u=>u.email===email);

    if(!user){
        alert("Email not found");
        return;
    }

    resetCode = generateCode();
    resetEmail = email;

    emailjs.send(
        "service_w7msx75",
        "template_d67hhwh",
        {
            to_email:email,
            reset_code:resetCode
        }
    ).then(function(){

        alert("Reset code sent successfully");

        document.getElementById("resetFields").style.display="block";

    }).catch(function(){

        alert("Failed to send reset code");

    });

}

// UPDATE PASSWORD
function updatePassword(){

    let code = document.getElementById("fp_code").value;
    let newpass = document.getElementById("fp_newpass").value;
    let confirm = document.getElementById("fp_confirmpass").value;

    if(code != resetCode){
        alert("Invalid reset code");
        return;
    }

    if(newpass !== confirm){
        alert("Passwords do not match");
        return;
    }

    let freelancers = getFreelancers() || [];

    let user = freelancers.find(u=>u.email===resetEmail);

    if(!user){
        alert("User not found");
        return;
    }

    user.password = newpass;

    saveFreelancers(freelancers);

    setSession(user,"freelancer");

    location.href="freelancerdashboard.html";

}
</script>

</body>
  </html>
